generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}


model Tenant {
  slug                String   @id
  name                String
  adminPasswordHash   String
  contactEmail        String
  registrationEmail   String   @default("")
  contactPhone        String?
  address             String?
  timezone            String   @default("Europe/Rome")
  
  // Settings stored as JSON: slots, fullDayEnabled, buffer, etc.
  // Also includes: content (titles, emails), infoBox
  settings            Json? 
  tokenVersion        Int      @default(0)

  // Password Recovery
  passwordResetToken   String?   @unique
  passwordResetExpires DateTime?

  bikeTypes           BikeType[]
  bookings            Booking[]
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model BikeType {
  id          String   @id @default(cuid())
  tenantSlug  String
  name        String
  totalStock  Int      @default(0)
  brokenCount Int      @default(0)
  notes       String?
  costPerHour Float    @default(0)

  tenant      Tenant   @relation(fields: [tenantSlug], references: [slug], onDelete: Cascade)
  bookings    Booking[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum BookingStatus {
  PENDING_CONFIRM
  CONFIRMED
  REJECTED
  CANCELLED
  COMPLETED
  PAID
  NO_SHOW
}

model Booking {
  id                String        @id @default(cuid())
  tenantSlug        String
  bikeTypeId        String
  
  status            BookingStatus @default(PENDING_CONFIRM)
  
  // Booking code for customers (generated on confirmation)
  bookingCode       String?       @unique
  
  startTime         DateTime
  endTime           DateTime
  
  // Customer Info
  customerName      String
  customerEmail     String
  customerPhone     String
  
  quantity          Int           @default(1)
  totalPrice        Float         @default(0)
  paidAmount        Float         @default(0)
  
  // Confirmation logic
  confirmationToken String?       @unique
  expiresAt         DateTime?     // When pending confirmation expires
  
  // Use tosAcceptedAt to track acceptance time, existence implies true
  tosAcceptedAt     DateTime?

  tenant            Tenant        @relation(fields: [tenantSlug], references: [slug], onDelete: Cascade)
  bikeType          BikeType      @relation(fields: [bikeTypeId], references: [id], onDelete: Cascade)

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([tenantSlug])
  @@index([status])
  @@index([confirmationToken])
  @@index([bookingCode])
}

model SuperAdmin {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  tokenVersion Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model AdminLoginAttempt {
  id        String   @id @default(cuid())
  ipAddress String
  email     String
  success   Boolean  @default(false)
  createdAt DateTime @default(now())
  
  @@index([ipAddress])
  @@index([email])
  @@index([createdAt])
}

model RateLimit {
  key       String   @id // identifier e.g. "login:127.0.0.1"
  count     Int      @default(0)
  expiresAt DateTime
}


enum LogLevel {
  INFO
  WARN
  ERROR
}

enum ActorType {
  GUEST
  TENANT_ADMIN
  SUPER_ADMIN
  SYSTEM
}

model EventLog {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  level       LogLevel
  tenantId    String?
  actorType   ActorType
  actorId     String?
  eventType   String
  entityType  String?
  entityId    String?
  ipHash      String?
  userAgent   String?
  message     String
  metadata    Json?

  @@index([tenantId, createdAt])
  @@index([level, createdAt])
  @@index([eventType, createdAt])
}

model EmailTemplate {
  id          String   @id // e.g., "confirmation", "recap", "onboarding", "password_reset", "manual_admin", "notification", "signup_request"
  subject     String
  senderName  String?  // Optional sender alias e.g. "MTB Reserve"
  senderEmail String?  // Optional specific sender e.g. "bookings@mtbreserve.com"
  html        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model SystemSettings {
  id                 String   @id @default("settings") // Singleton
  
  // SEO
  serpTitle          String   @default("MTB Reserve - Bike Rental Platform")
  serpDescription    String   @default("Book mountain bikes and e-bikes from local rental shops. Easy online reservations.")
  seoKeywords        String[] @default(["bike rental", "mountain bike", "e-bike", "booking"])
  
  // Branding
  faviconUrl         String?
  socialImageUrl     String?

  // Notifications
  adminNotificationEmail String? @default("contact@mtbreserve.com")
  
  updatedAt          DateTime @updatedAt
}

